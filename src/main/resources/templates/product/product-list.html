<html
        xmlns:th="http://thymeleaf.org"
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        layout:decorate="~{layout}">
<head>
    <title>Products</title>
    <link rel="stylesheet" th:href="@{/css/product-list.css}">
</head>
<body class="d-flex flex-column h-100">
<main class="flex-shrink-0">
    <section layout:fragment="body" class="py-5">
        <div class="container px-5 my-5">
            <div th:if="${param.success}" class="alert alert-success">
                You are registered successfully!
            </div>

            <div class="d-md-none mb-3">
                <button class="btn btn-filter-toggle w-100" type="button"
                        data-bs-toggle="collapse" data-bs-target="#filtersCollapse"
                        aria-expanded="false" aria-controls="filtersCollapse">
                    Filter Products
                    <i class="bi bi-sliders"></i>
                </button>
            </div>

            <nav class="breadcrumb-lite">
                <a th:href="@{/}">Home</a>
                <span class="sep">›</span>
                <span id="crumb-tail"
                      th:text="${activeCategory != null and activeCategory.name != null ? activeCategory.name : 'All Products'}">
                </span>
            </nav>

            <!-- Header: Title + Sort -->
            <div class="catalog-head">
                <div class="title-block">
                    <h1 class="page-title" id="listTitle"
                        th:text="${activeCategory != null && activeCategory.name != null ? activeCategory.name : 'All Products'}">
                        All Products
                    </h1>
                    <div id="product-count" class="count-pill" th:text=" ${totalItems} + ' products'">(12 products)</div>
                </div>

                <div class="sort-control" data-open="false">
                    <button type="button" class="sort-btn" id="sortBtn">
                        <span class="sort-label">Sort by: <span id="sortCurrent">Recommended</span></span>
                        <i class="bi bi-chevron-down" style="color:#fff; font-size:1.1rem; position:relative; top:1px;"></i>
                    </button>

                    <ul class="sort-menu" id="sortMenu">
                        <li><button type="button" data-key="rec">Recommended</button></li>
                        <li><button type="button" data-key="new">Newest</button></li>
                        <li><button type="button" data-key="plh">Price (low to high)<i class="bi bi-arrow-up" style="color:#fff; font-size:1rem; margin-left:8px;"></i></button></li>
                        <li><button type="button" data-key="phl">Price (high to low)<i class="bi bi-arrow-down" style="color:#fff; font-size:1rem; margin-left:8px;"></i></button></li>
                        <li><button type="button" data-key="naz">Name A–Z</button></li>
                        <li><button type="button" data-key="nza">Name Z–A</button></li>
                    </ul>
                </div>
            </div>


            <div class="catalog-layout">
                <aside class="filter-sidebar slim">
                    <form method="get" th:action="@{/products/list}" id="filter-form" class="side-filter">
                        <h4 class="fs-title browse-title">Browse by</h4>
                        <ul class="cat-list links">
                            <li>
                                <a th:href="@{/products/list}"
                                   class="all-link"
                                   th:classappend="${categoryId == null ? 'active' : ''}">
                                    All Products
                                </a>
                            </li>
                            <li th:each="c : ${categories}">
                                <label class="cat-row" th:classappend="${c.id == categoryId ? 'active' : ''}">
                                    <input type="radio" name="category_id" th:value="${c.id}" th:checked="${c.id == categoryId}">
                                    <span th:text="${c.name}">Category</span>
                                </label>
                            </li>
                        </ul>

                        <h4 class="fs-title filter-title mt-4">Filter by</h4>

                        <div class="price-block mt-3">
                            <div class="price-row">
                                <span class="field-label">Price</span>
                                <span class="minus">–</span>
                            </div>
                            <div class="range-wrap">
                                <input id="priceMin" type="range" min="0" max="5000" step="1" name="minPrice" th:value="${minPrice != null ? minPrice : 0}">
                                <input id="priceMax" type="range" min="0" max="5000" step="1" name="maxPrice" th:value="${maxPrice != null ? maxPrice : 5000}">
                                <div class="range-track"></div>
                            </div>
                            <div class="price-values">
                                <span id="minVal" th:text="${minPrice != null ? '$' + minPrice : '$0'}">$0</span>
                                <span id="maxVal" th:text="${maxPrice != null ? '$' + maxPrice : '$5000'}">$5000</span>
                            </div>
                        </div>

                        <input type="hidden" name="sortBy" th:value="${sortBy}">
                        <input type="hidden" name="direction" th:value="${direction}">
                        <input type="hidden" name="q" th:value="${q}">
                        <input type="hidden" name="size" th:value="${size}">
                        <input type="hidden" name="page_no" value="0">
                    </form>
                </aside>

                <section class="catalog-content">
                    <div id="product-container" class="row row-cols-1 row-cols-sm-2 row-cols-md-2 g-5 mb-4"></div>
                    <div id="pagination" class="pagination mt-3"></div>
                </section>
            </div>


        </div>
        </div>
    </section>
</main>
</body>
</html>

<script th:inline="javascript">
    const userEmail = /*[[${email}]]*/ null;
</script>
<script>
    function getActiveForm() {
        return document.getElementById("filter-form")
            || document.getElementById("filter-form-mobile")
            || null;
    }

    document.addEventListener("DOMContentLoaded", () => {
        const form = getActiveForm();
        hydrateFormFromURL(form);
        applyFilters(false, form);

        if (form) {
            form.addEventListener("submit", (e) => {
                e.preventDefault();
                const pageNo = form.elements.namedItem('page_no');
                if (pageNo) pageNo.value = '0';
                applyFilters(false, form);
            });
        }
    });

    function hydrateFormFromURL(form) {
        if (!form) return;
        const params = new URLSearchParams(window.location.search);
        for (const [k, v] of params.entries()) {
            const el = form.elements.namedItem(k);
            if (!el) continue;
            if (el.type === 'radio') {
                const r = form.querySelector(`[name="${k}"][value="${v}"]`);
                if (r) r.checked = true;
            } else {
                el.value = v;
            }
        }
    }

    function applyFilters(updateHistory = true, form = getActiveForm()) {
        if (!form) return;
        const params = new URLSearchParams(new FormData(form)).toString();
        if (updateHistory) {
            history.replaceState(null, '', window.location.pathname + '?' + params);
        } else {
            history.replaceState(null, '', window.location.pathname + '?' + params);
        }
        loadProducts(params);
    }

    async function loadProducts(params = '') {
        const container = document.getElementById('product-container');
        const pager = document.getElementById('pagination');

        container.innerHTML = '<div class="p-3">Loading...</div>';
        if (pager) pager.innerHTML = '';

        try {
            const res = await fetch('/products/api?' + params, { credentials: 'same-origin' });
            if (!res.ok) {
                const text = await res.text();
                container.innerHTML = `<div class="text-danger p-3">Failed (${res.status}).</div>`;
                console.error('API error', res.status, text.slice(0, 200));
                return;
            }
            const data = await res.json(); // Page<ProductDto>

            const countEl = document.getElementById('product-count');
            if (countEl && typeof data.totalElements === 'number') {
                const n = data.totalElements;
                const fmt = new Intl.NumberFormat();
                countEl.textContent = `${fmt.format(n)} ${n === 1 ? 'product' : 'products'}`;
            }

            if (!data.content || data.content.length === 0) {
                container.innerHTML = '<div class="p-3">No products found.</div>';
            } else {
                container.innerHTML = data.content.map(p => productCard(p)).join('');
            }

            renderPagination(data);
        } catch (e) {
            container.innerHTML = '<div class="text-danger p-3">Error loading products.</div>';
            console.error(e);
        }
    }

    function productCard(p){
        const id    = Number(p.id);
        const stock = Number(p.stockQuantity ?? 0);
        const price = (p.price != null) ? `$${p.price}` : '';
        const img   = p.imageUrl || '/images/placeholder.png';
        const name  = escapeHtml(p.name || '');
        const desc  = escapeHtml(p.description || '');

        return `
    <div class="col">
      <div class="product-card h-100">
        <div class="image-container">
          <img src="${img}" alt="${name}">
        </div>
        <div class="content-info">
          <div class="product-name">${name}</div>
          <div class="product-desc">${desc}</div>
          <div class="product-price">${price}</div>

          <div class="view-add-buttons mt-2">
            <a class="btn detail-button" href="/products/${encodeURIComponent(id)}">
              <i class="bi bi-eye"></i> View Details
            </a>

            ${
            stock > 0
                ? `
                  <form method="post" action="/cart/add/${encodeURIComponent(id)}" style="display:inline;">
                    <button class="btn detail-button" type="submit">
                      <i class="bi bi-cart-plus"></i> Add To Cart
                    </button>
                  </form>
                `
                : `
                  <button class="btn btn-outline-dark" style="color:white" onclick="registerNotify(${id})">
                    Notify Me
                  </button>
                `
        }
          </div>
        </div>
      </div>
    </div>`;
    }

    function escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, m => (
            {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]
        ));
    }

    function renderPagination(page) {
        const pager = document.getElementById('pagination');
        if (!pager) return;

        const cur = page.number ?? 0;
        const total = page.totalPages ?? 0;

        if (!total || total <= 1) { pager.innerHTML = ''; return; }

        const btn = (label, enabled, target) =>
            enabled ? `<button class="page-btn mx-2" onclick="goToPage(${target})">${label}</button>`
                : `<span class="page-btn disabled mx-2">${label}</span>`;

        const range = [];
        const start = Math.max(0, cur - 2);
        const end = Math.min(total - 1, cur + 2);
        for (let i = start; i <= end; i++) {
            range.push(i === cur
                ? `<span class="page-btn active mx-1">${i + 1}</span>`
                : `<button class="page-btn mx-1" onclick="goToPage(${i})">${i + 1}</button>`);
        }

        pager.innerHTML = [
            btn('First', cur > 0, 0),
            btn('Prev', cur > 0, cur - 1),
            ...range,
            btn('Next', cur < total - 1, cur + 1),
            btn('Last', cur < total - 1, total - 1)
        ].join(' ');
    }

    function goToPage(n) {
        const form = getActiveForm();
        if (!form) return;
        const hidden = form.elements.namedItem('page_no') || form.elements.namedItem('page');
        if (hidden) hidden.value = String(n);
        applyFilters();
    }


    async function registerNotify(productId){
        if (!userEmail){
            alert('Please log in to use notifications.');
            return;
        }

        try {
            const params = new URLSearchParams({ productId, email: userEmail });
            const res = await fetch('/notifications/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: params.toString()
            });

            if (res.ok){
                alert(await res.text());
            } else if (res.status === 409) {
                alert(await res.text());
            } else {
                alert('Failed to register notification.');
            }
        } catch (err){
            console.error(err);
            alert('Network error.');
        }
    }

    (function(){
        const form  = document.getElementById('filter-form');
        const minEl = document.getElementById('priceMin');
        const maxEl = document.getElementById('priceMax');
        const minVal= document.getElementById('minVal');
        const maxVal= document.getElementById('maxVal');
        const track = document.querySelector('.range-track');
        if(!minEl || !maxEl || !track) return;

        const MIN_GAP = 1;
        const bg  = 'rgba(255,255,255,.18)';
        const sel = 'rgba(255,255,255,.85)';


        if (!minEl.value) minEl.value = minEl.min;
        if (!maxEl.value) maxEl.value = maxEl.max;

        function paint(a,b){
            const min = +minEl.min, max = +maxEl.max;
            const L = ((a - min) / (max - min)) * 100;
            const R = ((b - min) / (max - min)) * 100;
            track.style.background =
                `linear-gradient(to right, ${bg} 0%, ${bg} ${L}%,
                             ${sel} ${L}%, ${sel} ${R}%,
                             ${bg} ${R}%, ${bg} 100%)`;
        }

        function clampAndPaint(){
            let a = +minEl.value, b = +maxEl.value;
            if (a > b - MIN_GAP) { a = b - MIN_GAP; minEl.value = a; }
            if (b < a + MIN_GAP) { b = a + MIN_GAP; maxEl.value = b; }
            minVal.textContent = `$${a}`;
            maxVal.textContent = `$${b}`;
            paint(a,b);
        }


        let t;
        function autoApply(){
            clearTimeout(t);
            t = setTimeout(()=>{
                const pageNo = form?.elements?.namedItem('page_no');
                if(pageNo) pageNo.value = '0';
                if (typeof applyFilters === 'function') applyFilters(true, form);
            }, 160);
        }

        minEl.addEventListener('input', ()=>{ clampAndPaint(); autoApply(); });
        maxEl.addEventListener('input', ()=>{ clampAndPaint(); autoApply(); });

        clampAndPaint();


        const categoryRadios = document.querySelectorAll('input[name="category_id"]');
        const allLink = document.querySelector('.all-link');
        const catRows = document.querySelectorAll('.cat-row');


        categoryRadios.forEach(radio => {
            radio.addEventListener('change', function() {

                allLink.classList.remove('active');
                catRows.forEach(row => row.classList.remove('active'));


                this.closest('.cat-row').classList.add('active');
                updateBreadcrumbFromState()

                const pageNo = form?.elements?.namedItem('page_no');
                if(pageNo) pageNo.value = '0';


                if (typeof applyFilters === 'function') {
                    applyFilters(true, form);
                }
            });
        });


        if(allLink) {
            allLink.addEventListener('click', function(e) {
                e.preventDefault();


                categoryRadios.forEach(radio => radio.checked = false);
                catRows.forEach(row => row.classList.remove('active'));
                this.classList.add('active');

                updateBreadcrumbFromState()

                const categoryInputs = form.querySelectorAll('input[name="category_id"]');
                categoryInputs.forEach(input => input.checked = false);

                const pageNo = form?.elements?.namedItem('page_no');
                if(pageNo) pageNo.value = '0';

                if (typeof applyFilters === 'function') {
                    applyFilters(true, form);
                }
            });
        }
    })();

    function updateBreadcrumbFromState(){
        const crumb = document.getElementById('crumb-tail');
        const pageTitle = document.getElementById('listTitle');

        if (!crumb) return;
        if (!pageTitle) return;

        let text = 'All Products';
        const checked = document.querySelector('input[name="category_id"]:checked');
        if (checked) {
            const row = checked.closest('.cat-row');
            const span = row?.querySelector('span');
            if (span) text = span.textContent.trim();
        }
        crumb.textContent = text;
        pageTitle.textContent = text;
    }

    updateBreadcrumbFromState();

    (function(){
        const form = document.getElementById('filter-form');
        const sortBtn  = document.getElementById('sortBtn');
        const sortMenu = document.getElementById('sortMenu');
        const sortWrap = document.querySelector('.sort-control');
        const sortCurrent = document.getElementById('sortCurrent');

        if(!form || !sortBtn || !sortMenu || !sortWrap) return;

        const sortByInput  = form.querySelector('input[name="sortBy"]')  || (()=>{ const i=document.createElement('input'); i.type='hidden'; i.name='sortBy'; form.appendChild(i); return i; })();
        const dirInput     = form.querySelector('input[name="direction"]')|| (()=>{ const i=document.createElement('input'); i.type='hidden'; i.name='direction'; form.appendChild(i); return i; })();

        const MAP = {
            rec:  { label:'Recommended', sortBy:'',      dir:''     },
            new:  { label:'Newest',      sortBy:'id',    dir:'desc' },
            plh:  { label:'Price (low to high)', sortBy:'price', dir:'asc'  },
            phl:  { label:'Price (high to low)', sortBy:'price', dir:'desc' },
            naz:  { label:'Name A–Z',    sortBy:'name',  dir:'asc'  },
            nza:  { label:'Name Z–A',    sortBy:'name',  dir:'desc' },
        };

        sortBtn.addEventListener('click', ()=> {
            const open = sortWrap.getAttribute('data-open') === 'true';
            sortWrap.setAttribute('data-open', open ? 'false' : 'true');
        });
        document.addEventListener('click', (e)=>{
            if(!sortWrap.contains(e.target)) sortWrap.setAttribute('data-open','false');
        });

        sortMenu.querySelectorAll('button').forEach(btn=>{
            btn.addEventListener('click', ()=>{
                const key = btn.getAttribute('data-key');
                const cfg = MAP[key]; if(!cfg) return;

                sortCurrent.textContent = cfg.label;

                sortByInput.value = cfg.sortBy;
                dirInput.value    = cfg.dir;

                const pageNo = form.elements.namedItem('page_no');
                if (pageNo) pageNo.value = '0';

                if (typeof applyFilters === 'function') applyFilters(true, form);
                sortWrap.setAttribute('data-open','false');
            });
        });


        (function initSortLabel(){
            const s = (sortByInput.value || '').toLowerCase();
            const d = (dirInput.value || '').toLowerCase();
            let label = 'Recommended';

            if (s === 'id' && d === 'desc') label = 'Newest';
            else if (s === 'price' && d === 'asc')  label = 'Price (low to high)';
            else if (s === 'price' && d === 'desc') label = 'Price (high to low)';
            else if (s === 'name'  && d === 'asc')  label = 'Name A–Z';
            else if (s === 'name'  && d === 'desc') label = 'Name Z–A';

            sortCurrent.textContent = label;
        })();
    })();
    /*
    document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("filter-form");
        form.addEventListener("submit", (e) => {
            e.preventDefault();
            const params = new URLSearchParams(new FormData(e.target)).toString();
            loadProducts(params);
        });
    });

    async function loadProducts(params = '') {
        const response = await fetch('/products/api?' + params, { credentials: 'same-origin' });
        const data = await response.json();

        const container = document.getElementById('product-container');
        container.innerHTML = '';
        data.content.forEach(p => {
            container.innerHTML += `
      <div class="col-lg-6 mb-4">
        <div class="product-card">
          <div class="image-container">
            <img src="${p.imageUrl}" alt="${p.name}" class="mb-3"/>
          </div>
          <div class="content-info">
            <div><strong>${p.name}</strong></div>
            <div>${p.description ?? ''}</div>
            <div>$${p.price}</div>
          </div>
        </div>
      </div>`;
        });
    } */
</script>
<html
        xmlns:th="http://thymeleaf.org"
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        layout:decorate="~{layout}">
<head>
    <title>Products</title>
    <link rel="stylesheet" th:href="@{/css/product-list.css}">
</head>
<body class="d-flex flex-column h-100">
<main class="flex-shrink-0">
    <section layout:fragment="body" class="py-5">
        <div class="container px-5 my-5">
            <div th:if="${param.success}" class="alert alert-success">
                You are registered successfully!
            </div>
            <div class="text-center mb-5">
                <h1 class="fw-bolder">Find Your Interest</h1>
                <p class="lead fw-normal text-muted mb-0">Explore products tailored to your needs</p>
            </div>

            <div class="d-md-none mb-3">
                <button class="btn btn-filter-toggle w-100" type="button"
                        data-bs-toggle="collapse" data-bs-target="#filtersCollapse"
                        aria-expanded="false" aria-controls="filtersCollapse">
                    Filter Products
                    <i class="bi bi-sliders"></i>
                </button>
            </div>

            <!-- Slim Filter Bar (under navbar) -->
            <div class="filter-bar border-bottom">
                <div class="container-xxl px-4">
                    <!-- desktop / tablet inline -->
                    <form method="get" th:action="@{/products/list}" class="filter-inline d-none d-md-flex" id="filter-form">

                        <select name="category_id" class="form-select fld"
                                aria-label="Category">
                            <option value="">All</option>
                            <option th:each="category : ${categories}"
                                    th:value="${category.id}"
                                    th:text="${category.name}"
                                    th:selected="${category.id == categoryId}">
                            </option>
                        </select>

                        <input type="number" class="form-control fld" name="minPrice"
                               th:value="${minPrice}" placeholder="Min">

                        <input type="number" class="form-control fld" name="maxPrice"
                               th:value="${maxPrice}" placeholder="Max">

                        <select name="sortBy" class="form-select fld"
                                th:value="${sortBy != null ? sortBy : ''}">
                            <option value="">Sort</option>
                            <option value="price" th:selected="${sortBy=='price'}">Price</option>
                            <option value="name"  th:selected="${sortBy=='name'}">Name</option>
                            <option value="id"    th:selected="${sortBy=='id'}">ID</option>
                        </select>

                        <div class="btn-group btn-group-sm fld-dir" role="group" aria-label="Direction">
                            <input type="radio" class="btn-check" name="direction" id="dirAsc" value="asc"  th:checked="${direction=='asc'}">
                            <label class="btn btn-dir" for="dirAsc">ASC</label>
                            <input type="radio" class="btn-check" name="direction" id="dirDesc" value="desc" th:checked="${direction=='desc'}">
                            <label class="btn btn-dir" for="dirDesc">DESC</label>
                        </div>

                        <input type="hidden" name="q">
                        <input type="hidden" name="size" th:value="${size}">
                        <input type="hidden" name="page_no" value="0">

                        <button type="submit" class="btn btn-apply">Apply</button>
                        <a th:href="@{/products/list}" class="btn btn-reset">Reset</a>
                    </form>

                    <!-- mobile toggle -->
                    <div class="d-md-none py-2">
                        <button class="btn btn-filter-toggle w-100" data-bs-toggle="collapse" data-bs-target="#filtersPanel"
                                aria-expanded="false" aria-controls="filtersPanel">
                            Filters
                            <i class="bi bi-sliders"></i>
                        </button>
                        <div id="filtersPanel" class="collapse mt-2">
                            <form method="get" th:action="@{/products/list}" class="filter-panel" id="filter-form-mobile">
                                <select name="category_id" class="form-select mb-2">
                                    <option value="">All</option>
                                    <option th:each="category : ${categories}"
                                            th:value="${category.id}"
                                            th:text="${category.name}"
                                            th:selected="${category.id == categoryId}">
                                    </option>
                                </select>

                                <div class="row g-2 mb-2">
                                    <div class="col-6">
                                        <input type="number" class="form-control" name="minPrice" th:value="${minPrice}" placeholder="Min">
                                    </div>
                                    <div class="col-6">
                                        <input type="number" class="form-control" name="maxPrice" th:value="${maxPrice}" placeholder="Max">
                                    </div>
                                </div>

                                <div class="row g-2 mb-2">
                                    <div class="col-6">
                                        <select name="sortBy" class="form-select" th:value="${sortBy != null ? sortBy : ''}">
                                            <option value="">Sort</option>
                                            <option value="price" th:selected="${sortBy=='price'}">Price</option>
                                            <option value="name"  th:selected="${sortBy=='name'}">Name</option>
                                            <option value="id"    th:selected="${sortBy=='id'}">ID</option>
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <div class="btn-group btn-group-sm w-100" role="group">
                                            <input type="radio" class="btn-check" name="direction" id="mAsc" value="asc"  th:checked="${direction=='asc'}">
                                            <label class="btn btn-dir w-50" for="mAsc">ASC</label>
                                            <input type="radio" class="btn-check" name="direction" id="mDesc" value="desc" th:checked="${direction=='desc'}">
                                            <label class="btn btn-dir w-50" for="mDesc">DESC</label>
                                        </div>
                                    </div>
                                </div>

                                <input type="hidden" name="q">
                                <input type="hidden" name="size" th:value="${size}">
                                <input type="hidden" name="page_no" value="0">

                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-apply">Apply</button>
                                    <a th:href="@{/products/list}" class="btn btn-reset">Reset</a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>


            <div id="product-container" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-5 mb-4">

            </div>

          </div>
        </div>

        <div id="pagination" class="pagination mt-3">

        </div>

    </section>
</main>
</body>
</html>

<script th:inline="javascript">
    const userEmail = /*[[${email}]]*/ null;
</script>
<script>
    function getActiveForm() {
        return document.getElementById("filter-form")
            || document.getElementById("filter-form-mobile")
            || null;
    }

    document.addEventListener("DOMContentLoaded", () => {
        const form = getActiveForm();
        hydrateFormFromURL(form);
        applyFilters(false, form);

        if (form) {
            form.addEventListener("submit", (e) => {
                e.preventDefault();
                const pageNo = form.elements.namedItem('page_no');
                if (pageNo) pageNo.value = '0';
                applyFilters(false, form);
            });
        }
    });

    function hydrateFormFromURL(form) {
        if (!form) return;
        const params = new URLSearchParams(window.location.search);
        for (const [k, v] of params.entries()) {
            const el = form.elements.namedItem(k);
            if (!el) continue;
            if (el.type === 'radio') {
                const r = form.querySelector(`[name="${k}"][value="${v}"]`);
                if (r) r.checked = true;
            } else {
                el.value = v;
            }
        }
    }

    function applyFilters(updateHistory = true, form = getActiveForm()) {
        if (!form) return;
        const params = new URLSearchParams(new FormData(form)).toString();
        if (updateHistory) {
            history.replaceState(null, '', window.location.pathname + '?' + params);
        } else {
            history.replaceState(null, '', window.location.pathname + '?' + params);
        }
        loadProducts(params);
    }

    async function loadProducts(params = '') {
        const container = document.getElementById('product-container');
        const pager = document.getElementById('pagination');

        container.innerHTML = '<div class="p-3">Loading...</div>';
        if (pager) pager.innerHTML = '';

        try {
            const res = await fetch('/products/api?' + params, { credentials: 'same-origin' });
            if (!res.ok) {
                const text = await res.text();
                container.innerHTML = `<div class="text-danger p-3">Failed (${res.status}).</div>`;
                console.error('API error', res.status, text.slice(0, 200));
                return;
            }
            const data = await res.json(); // Page<ProductDto>

            if (!data.content || data.content.length === 0) {
                container.innerHTML = '<div class="p-3">No products found.</div>';
            } else {
                container.innerHTML = data.content.map(p => productCard(p)).join('');
            }

            renderPagination(data);
        } catch (e) {
            container.innerHTML = '<div class="text-danger p-3">Error loading products.</div>';
            console.error(e);
        }
    }

    function productCard(p){
        const id    = Number(p.id);
        const stock = Number(p.stockQuantity ?? 0);
        const price = (p.price != null) ? `$${p.price}` : '';
        const img   = p.imageUrl || '/images/placeholder.png';
        const name  = escapeHtml(p.name || '');
        const desc  = escapeHtml(p.description || '');

        return `
    <div class="col">
      <div class="product-card h-100">
        <div class="image-container">
          <img src="${img}" alt="${name}">
        </div>
        <div class="content-info">
          <div class="product-name">${name}</div>
          <div class="product-desc">${desc}</div>
          <div class="product-price">${price}</div>

          <div class="view-add-buttons mt-2">
            <a class="btn detail-button" href="/products/${encodeURIComponent(id)}">
              <i class="bi bi-eye"></i> View Details
            </a>

            ${
            stock > 0
                ? `
                  <form method="post" action="/cart/add/${encodeURIComponent(id)}" style="display:inline;">
                    <button class="btn detail-button" type="submit">
                      <i class="bi bi-cart-plus"></i> Add To Cart
                    </button>
                  </form>
                `
                : `
                  <button class="btn btn-outline-dark" style="color:white" onclick="registerNotify(${id})">
                    Notify Me
                  </button>
                `
        }
          </div>
        </div>
      </div>
    </div>`;
    }

    function escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, m => (
            {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]
        ));
    }

    function renderPagination(page) {
        const pager = document.getElementById('pagination');
        if (!pager) return;

        const cur = page.number ?? 0;
        const total = page.totalPages ?? 0;

        if (!total || total <= 1) { pager.innerHTML = ''; return; }

        const btn = (label, enabled, target) =>
            enabled ? `<button class="page-btn mx-2" onclick="goToPage(${target})">${label}</button>`
                : `<span class="page-btn disabled mx-2">${label}</span>`;

        const range = [];
        const start = Math.max(0, cur - 2);
        const end = Math.min(total - 1, cur + 2);
        for (let i = start; i <= end; i++) {
            range.push(i === cur
                ? `<span class="page-btn active mx-1">${i + 1}</span>`
                : `<button class="page-btn mx-1" onclick="goToPage(${i})">${i + 1}</button>`);
        }

        pager.innerHTML = [
            btn('First', cur > 0, 0),
            btn('Prev', cur > 0, cur - 1),
            ...range,
            btn('Next', cur < total - 1, cur + 1),
            btn('Last', cur < total - 1, total - 1)
        ].join(' ');
    }

    function goToPage(n) {
        const form = getActiveForm();
        if (!form) return;
        const hidden = form.elements.namedItem('page_no') || form.elements.namedItem('page');
        if (hidden) hidden.value = String(n);
        applyFilters();
    }


    async function registerNotify(productId){
        if (!userEmail){
            alert('Please log in to use notifications.');
            return;
        }

        try {
            const params = new URLSearchParams({ productId, email: userEmail });
            const res = await fetch('/notifications/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: params.toString()
            });

            if (res.ok){
                alert(await res.text());
            } else if (res.status === 409) {
                alert(await res.text());
            } else {
                alert('Failed to register notification.');
            }
        } catch (err){
            console.error(err);
            alert('Network error.');
        }
    }



    /*
    document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("filter-form");
        form.addEventListener("submit", (e) => {
            e.preventDefault();
            const params = new URLSearchParams(new FormData(e.target)).toString();
            loadProducts(params);
        });
    });

    async function loadProducts(params = '') {
        const response = await fetch('/products/api?' + params, { credentials: 'same-origin' });
        const data = await response.json();

        const container = document.getElementById('product-container');
        container.innerHTML = '';
        data.content.forEach(p => {
            container.innerHTML += `
      <div class="col-lg-6 mb-4">
        <div class="product-card">
          <div class="image-container">
            <img src="${p.imageUrl}" alt="${p.name}" class="mb-3"/>
          </div>
          <div class="content-info">
            <div><strong>${p.name}</strong></div>
            <div>${p.description ?? ''}</div>
            <div>$${p.price}</div>
          </div>
        </div>
      </div>`;
        });
    } */
</script>
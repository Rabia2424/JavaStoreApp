<html
        xmlns:th="http://thymeleaf.org"
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        layout:decorate="~{layout}">
<head>
    <title>Products</title>
    <link rel="stylesheet" th:href="@{/css/product-list.css}">
</head>
<body class="d-flex flex-column h-100">
<main class="flex-shrink-0">
    <section layout:fragment="body" class="py-5">
        <div class="container px-5 my-5">
            <div th:if="${param.success}" class="alert alert-success">
                You are registered successfully!
            </div>
            <div class="text-center mb-5">
                <h1 class="fw-bolder">Find Your Interest</h1>
                <p class="lead fw-normal text-muted mb-0">Explore products tailored to your needs</p>
            </div>

            <div class="row gx-5">
                <div class="my-4">
                    <form method="get" th:action="@{/products/list}" id="filter-form" class="filter-form">

                        <div class="d-flex align-items-center gap-3 w-100 mb-3">
                            <input
                                    name="q"
                                    id="search"
                                    class="search form-control flex-grow-1"
                                    type="search"
                                    placeholder="Search product name or description"
                                    aria-label="Search"
                                    th:value="${q}">
                        </div>

                        <div class="form-group mb-3">
                            <label>Select Category: </label>
                            <select name="category_id" class="form-select">
                                <option value="">All</option>
                                <option th:each="category : ${categories}"
                                        th:value="${category.id}"
                                        th:text="${category.name}"
                                        th:selected="${category.id == categoryId}">
                                </option>
                            </select>
                        </div>

                        <div class="row g-3 mb-3">
                            <div class="col-sm-6">
                                <label>Min Price: </label>
                                <input type="number" class="form-control" name="minPrice" th:value="${minPrice}">
                            </div>
                            <div class="col-sm-6">
                                <label>Max Price: </label>
                                <input type="number" class="form-control" name="maxPrice" th:value="${maxPrice}">
                            </div>
                        </div>

                        <div class="row g-3 mb-3 align-items-end">
                            <div class="col-sm-6">
                                <label class="me-2">Sort by:</label>
                                <select name="sortBy" class="form-select"
                                        th:value="${sortBy != null ? sortBy : ''}">
                                    <option value="">Select option</option>
                                    <option value="id"    th:selected="${sortBy=='id'}">ID</option>
                                    <option value="price" th:selected="${sortBy=='price'}">Price</option>
                                    <option value="name"  th:selected="${sortBy=='name'}">Name</option>
                                </select>
                            </div>
                            <div class="col-sm-6">
                                <label class="me-2">Direction:</label>
                                <select name="direction" class="form-select"
                                        th:value="${direction != null ? direction : ''}">
                                    <option value="">Select direction</option>
                                    <option value="asc"  th:selected="${direction=='asc'}">ASC</option>
                                    <option value="desc" th:selected="${direction=='desc'}">DESC</option>
                                </select>
                            </div>
                        </div>


                        <input type="hidden" name="size" th:value="${size}">
                        <input type="hidden" name="page_no" value="0">

                        <div class="mt-2 d-flex gap-2">
                            <button type="submit" class="btn btn-success">Apply</button>

                            <a class="btn btn-danger" th:href="@{/products/list}">Reset All</a>
                        </div>
                    </form>
                </div>
            </div>


            <div id="product-container" class="row gx-5">

            </div>

          </div>
        </div>

        <div id="pagination" class="pagination mt-3">

        </div>

    </section>
</main>
</body>
</html>
<script>
    document.addEventListener("DOMContentLoaded", () => {

        hydrateFormFromURL();
        applyFilters(false);

        const form = document.getElementById("filter-form");
        form.addEventListener("submit", (e) => {
            e.preventDefault();

            form.elements.namedItem('page_no').value = '0';
            applyFilters(false);
        });
    });


    function hydrateFormFromURL() {
        const p = new URLSearchParams(window.location.search);
        const form = document.getElementById('filter-form');
        for (const [k, v] of p.entries()) {
            const el = form.elements.namedItem(k);
            if (el) el.value = v;
        }
    }

    function applyFilters(updateHistory = true) {
        const form = document.getElementById('filter-form');
        const params = new URLSearchParams(new FormData(form)).toString();


        if (updateHistory) {
            history.replaceState(null, '', window.location.pathname + '?' + params);
        } else {

            history.replaceState(null, '', window.location.pathname + '?' + params);
        }

        loadProducts(params);
    }

    async function loadProducts(params = '') {
        const container = document.getElementById('product-container');
        const pager = document.getElementById('pagination');

        container.innerHTML = '<div class="p-3">Loading...</div>';
        pager.innerHTML = '';

        try {
            const res = await fetch('/products/api?' + params, { credentials: 'same-origin' });
            if (!res.ok) {
                const text = await res.text();
                container.innerHTML = `<div class="text-danger p-3">Failed (${res.status}).</div>`;
                console.error('API error', res.status, text.slice(0, 200));
                return;
            }
            const data = await res.json(); // Page<ProductDto>


            if (!data.content || data.content.length === 0) {
                container.innerHTML = '<div class="p-3">No products found.</div>';
            } else {
                container.innerHTML = data.content.map(p => productCard(p)).join('');
            }


            renderPagination(data);
        } catch (e) {
            container.innerHTML = '<div class="text-danger p-3">Error loading products.</div>';
            console.error(e);
        }
    }

    function productCard(p) {
        const price = (p.price != null) ? `$${p.price}` : '';
        const img = p.imageUrl || '/images/placeholder.png';
        const name = escapeHtml(p.name || '');
        const desc = escapeHtml(p.description || '');
        return `
    <div class="col-lg-6 mb-4">
      <div class="product-card">
        <div class="image-container">
          <img src="${img}" alt="${name}" class="mb-3"/>
        </div>
        <div class="content-info">
          <div><strong>${name}</strong></div>
          <div>${desc}</div>
          <div>${price}</div>
          <div class="view-add-buttons mt-2">
            <a class="btn detail-button" href="/products/${p.id}">View Details</a>
            <form method="post" action="/cart/add/${p.id}" style="display:inline;">
              <button class="btn detail-button" type="submit">Add To Cart</button>
            </form>
          </div>
        </div>
      </div>
    </div>`;
    }

    function escapeHtml(s) {
        return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }


    function renderPagination(page) {
        const pager = document.getElementById('pagination');
        const cur = page.number;
        const total = page.totalPages;

        if (!total || total <= 1) { pager.innerHTML = ''; return; }

        const btn = (label, enabled, target) =>
            enabled ? `<button class="page-btn mx-4" onclick="goToPage(${target})">${label}</button>`
                : `<span class="page-btn disabled mx-4">${label}</span>`;


        const range = [];
        const start = Math.max(0, cur - 2);
        const end = Math.min(total - 1, cur + 2);
        for (let i = start; i <= end; i++) {
            range.push(i === cur
                ? `<span class="page-btn active mx-2">${i + 1}</span>`
                : `<button class="page-btn mx-2" onclick="goToPage(${i})">${i + 1}</button>`);
        }

        pager.innerHTML = [
            btn('First', cur > 0, 0),
            btn('Prev', cur > 0, cur - 1),
            ...range,
            btn('Next', cur < total - 1, cur + 1),
            btn('Last', cur < total - 1, total - 1)
        ].join(' ');
    }


    function goToPage(n) {
        const form = document.getElementById('filter-form');
        const hidden = form.elements.namedItem('page_no') || form.elements.namedItem('page');
        if (hidden) hidden.value = String(n);
        applyFilters();
    }
    /*
    document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("filter-form");
        form.addEventListener("submit", (e) => {
            e.preventDefault();
            const params = new URLSearchParams(new FormData(e.target)).toString();
            loadProducts(params);
        });
    });

    async function loadProducts(params = '') {
        const response = await fetch('/products/api?' + params, { credentials: 'same-origin' });
        const data = await response.json();

        const container = document.getElementById('product-container');
        container.innerHTML = '';
        data.content.forEach(p => {
            container.innerHTML += `
      <div class="col-lg-6 mb-4">
        <div class="product-card">
          <div class="image-container">
            <img src="${p.imageUrl}" alt="${p.name}" class="mb-3"/>
          </div>
          <div class="content-info">
            <div><strong>${p.name}</strong></div>
            <div>${p.description ?? ''}</div>
            <div>$${p.price}</div>
          </div>
        </div>
      </div>`;
        });
    } */
</script>